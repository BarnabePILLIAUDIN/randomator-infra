name: Deploy

on: 
  # push:
  #   branches: 
  #     - main
  workflow_dispatch: 

jobs:
  deploy-aks-cluster:
    defaults:
      run:
        working-directory: ./terraform/azure
    runs-on: ubuntu-latest
    outputs:
      kubectl_command: ${{ steps.tf-outputs.outputs.kubectl_command }}
    environment: terraform
    env:
      # Terraform variables passed to the config (kept for backward compatibility)
      TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
      TF_VAR_azure_client_id: ${{ secrets.AZURE_CLIENT_ID}}
      TF_VAR_azure_client_secret: ${{ secrets.AZURE_CLIENT_SECRET}}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
    steps:
      - uses: actions/checkout@v5
      - uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Tofu init (Azure backend)
        run: |
          tofu init \
          -backend-config="storage_account_name=${{ vars.AZURE_BACKEND_STORAGE_ACCOUNT }}" \
          -backend-config="container_name=${{ vars.AZURE_BACKEND_STORAGE_CONTAINER }}" \
          -backend-config="key=terraform.tfstate" \
          -backend-config="resource_group_name=${{ vars.AZURE_BACKEND_RESOURCE_GROUP }}" \
          -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
          -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}"
      - name: Tofu validate
        run: tofu validate
      - name: Tofu apply
        run: tofu apply --auto-approve
      - name: Capture kubectl command output
        id: tf-outputs
        run: |
          # -raw returns the raw string without quotes/newlines
          echo "kubectl_command=$(tofu output -raw kubectl_config_command)" >> $GITHUB_OUTPUT

  deploy-apps:
    needs: deploy-aks-cluster
    runs-on: ubuntu-latest
    environment: terraform
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.27.3'
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Configure kubeconfig
        run: |
          set -euo pipefail
          cmd="${{ needs.deploy-aks-cluster.outputs.kubectl_command }}"
          if [ -z "$cmd" ]; then
            echo "kubectl_command is empty" >&2
            exit 1
          fi
          # Execute the command produced by Terraform to populate the kubeconfig
          eval "$cmd"
      - name: Show nodes
        run: kubectl get nodes