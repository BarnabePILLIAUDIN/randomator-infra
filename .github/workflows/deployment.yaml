name: Deployment

on: 
  push:
    branches: 
      - main

jobs:
  deploy-aks-cluster:
    defaults:
      run:
        working-directory: ./terraform/azure
    runs-on: ubuntu-latest
    environment: terraform
    env:
      TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
      TF_VAR_azure_client_id: ${{ secrets.AZURE_CLIENT_ID}}
      TF_VAR_azure_client_secret: ${{ secrets.AZURE_CLIENT_SECRET}}
    steps:
      - uses: actions/checkout@v5
      - uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Tofu init (Azure backend)
        run: |
          tofu init \
          -backend-config="storage_account_name=${{ vars.AZURE_BACKEND_STORAGE_ACCOUNT }}" \
          -backend-config="container_name=${{ vars.AZURE_BACKEND_STORAGE_CONTAINER }}" \
            -backend-config="key=terraform.tfstate" \
          -backend-config="resource_group_name=${{ vars.AZURE_BACKEND_RESOURCE_GROUP }}" \
          -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
          -backend-config="tenant_id=${{ secrets.AZURE_TENANT_ID }}"
      - name: Tofu validate
        run: tofu validate
      - name: Tofu apply
        run: tofu apply --auto-approve